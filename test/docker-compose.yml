version: '3'
services:
  doc:
    build: ..
    environment:
      LIBVIRT_USER_PASSWORD: libvirt-user
    hostname: doc
    privileged: true
    security_opt:
    - apparmor=unconfined
  sut:
    build: .
    command: ${SUT_CMD:-tail -F /dev/null}
    depends_on:
    - doc
    environment:
      CIDATA_IMAGE: /var/lib/libvirt/images/cidata.iso
      DISTRO_NAME: 'Ubuntu 20.04 LTS'
      DISTRO_IMAGE_CACHE: /mnt/cache/distro.img
      DISTRO_IMAGE_URL: https://cloud-images.ubuntu.com/focal/current/focal-server-cloudimg-amd64-disk-kvm.img
      DISTRO_IMAGE: /var/lib/libvirt/images/distro.img
      LIBVIRT_DEFAULT_URI: qemu+ssh://doc/system
      LIBVIRT_HOST: doc
      LIBVIRT_USER: libvirt-user
      MACHINE_BOOT_TIMEOUT_SECS: '120'
      MACHINE_MEMORY: '512'
      MACHINE_NAME: ubuntu
      MACHINE_NETWORK_DHCP_MAC: '52:54:00:12:34:56'
      MACHINE_NETWORK_STATIC_IPV4: '192.168.122.2'
      MACHINE_NETWORK_STATIC_MAC: '52:54:00:12:34:57'
      MACHINE_PASSWORD: ubuntu
      MACHINE_USER: ubuntu
      NETWORK_DEVICE: virtbr0
      NETWORK_DHCP_END_IPV4: '192.168.122.254'
      NETWORK_DHCP_START_IPV4: '192.168.122.128'
      NETWORK_IPV4: '192.168.122.1'
      NETWORK_MASK_IPV4: '255.255.255.0'
      NETWORK_MASK: '24'
      NETWORK_NAME: default
      PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/mnt/e2e:/mnt/scripts
      ROOTFS_IMAGE: /var/lib/libvirt/images/rootfs.qcow2
      SSHPASS: libvirt-user
      TEMPLATE_DIR: /mnt/templates
    hostname: sut
    volumes:
    - ./e2e:/mnt/e2e:ro
    - ./scripts:/mnt/scripts:ro
    - ./templates:/mnt/templates:ro
    - ${HOST_DISTRO_IMAGE:-/dev/null}:/mnt/cache/distro.img:ro # specified host file is used as cache
    working_dir: /mnt/e2e
