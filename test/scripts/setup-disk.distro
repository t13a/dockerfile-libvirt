#!/usr/bin/env bash

set -euo pipefail

if ssh "${LIBVIRT_HOST}" [ -f "${DISTRO_IMAGE}" ]
then
    diag echo "${DISTRO_IMAGE}: Already exists"
    exit 0
fi

(
    if [ -f "${DISTRO_IMAGE_CACHE}" ]
    then
        diag echo "${DISTRO_IMAGE_CACHE}: Cache exists"
        cat "${DISTRO_IMAGE_CACHE}"
    else
        curl -L "${DISTRO_IMAGE_URL}"
    fi
) | push-as-root "${DISTRO_IMAGE}.part"

ssh "${LIBVIRT_HOST}" sudo mv -f "${DISTRO_IMAGE}.part" "${DISTRO_IMAGE}"
